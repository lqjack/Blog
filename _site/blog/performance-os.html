<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Stay  hungry，Stay  foolish!">

    <title>性能调优-操作系统篇 - Page</title>

    <link rel="canonical" href="http://localhost:4000/blog/performance-os.html">

    <!-- Icons -->
  <link rel="shortcut icon" href="img/favicon.ico">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Page</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/2019-03-18-exceptions.html">异常</a>
                </li>
                
                <li>
                    <a href="/About.html">About</a>
                </li>
                
                <li>
                    <a href="/tags.html">Tags</a>
                </li>
                
                <li>
                    <a href="/photos/">Photos</a>
                </li>
                

            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/fantasy.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="Tags">
                        
                        <a class="tag" href="/Tags/#JVM" title="JVM">JVM</a>
                        
                        <a class="tag" href="/Tags/#Performance" title="Performance">Performance</a>
                        
                    </div>
                    <h1>性能调优-操作系统篇</h1>
                    
                    <span class="meta">Posted by Jack on February 24, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container">

                <h1 id="性能监控">性能监控</h1>
<p><small>以一种非入侵的方式收集或者查看应用性能数据的活动。监控通常是一种在生产、质量评估或者开发环境中实施的带有预防性或者主动性的活动。</small></p>

<h2 id="cpu使用率">CPU使用率</h2>
<ul>
  <li>用户态和系统态。用户态CPU使用率：执行应用程序代码的时间占总CPU时间的百分比。系统CPU使用率：执行系统调用的时间占总CPU时间百分比。</li>
  <li>系统态高意味着共享资源竞争或者IO设备有大量交互。目标是：提高应用的性能可扩展性，尽量减少系统CPU使用率。</li>
  <li>对于密集型应用，还要监控每分钟指令数（Instruction Per Clock）或每指令时钟周期（Cycle Per Instruction）等指标。</li>
  <li>现代操作系统自带的CPU使用率监控工具只能报告CPU使用率，没有CPU指令占用CPU时钟周期百分比。当CPU在等在内存中数据，仍会报告CPU繁忙。</li>
  <li>
    <p>当CPU执行指令所用的操作数不在寄存器或者缓存中时候，必须等待数据从内存装入CPU寄存器，导致CPU时间浪费。</p>
  </li>
  <li>图形监控工具：<code class="highlighter-rouge">gnome-system-monitor</code></li>
  <li>命令行：
    <pre><code class="language-Shell">  vmstat(us:用户态CPU使用率，sy:系统态CPU使用率，id：空闲率或者CPU可用率。us+sy+id=100),
  mpstat(usr,sys,wt:IO等待时间,idl)
  top
</code></pre>
  </li>
</ul>

<h2 id="cpu调度程序运行队列">CPU调度程序运行队列</h2>
<ul>
  <li>运行队列包含已经准备好运行，正在等待可用CPU的轻量级进程。若数量超过系统负荷，运行队列会很长。</li>
  <li>虚拟处理器的个数是系统硬件线程个数：Runtime.availableProcessors()。当运行长度队列超过虚拟处理4倍或者更多时，系统响应会很缓慢。</li>
  <li>一般性原则：运行队列长度超过虚拟处理个数1倍需要关注，但不需要立即处理。若长时间高于3-4倍，需要及时处理。</li>
  <li>解决办法：增加CPU分担负荷；减少处理数量。一种：从根本上减少虚拟处理器的处理数，减少运行队列中的轻量级线程；另一种：分析系统应用，改进CPU使用率。
    <h2 id="内存使用率">内存使用率</h2>
  </li>
  <li>除此之外，页面调度（页交换）、加锁、线程迁移中的让步和抢占式上下文切换。</li>
  <li>系统在进行页面交换或者使用虚拟内存时，Java应用或者JVM表现出明显的性能问题。当应用需要内存超过物理内存就会发送页面交换，为了缓解这个问题，需要配置swap空间（在独立的磁盘分区，应用耗尽物理内存时候，系统会将部分内存放置到swap空间（通常是最少运行部分）；当被访问的部分不在内存中时，则需要从swap空间移入内存）。对于系统的响应和吞吐有较大的影响。</li>
  <li>
    <p>JVM垃圾回收再页面交换时，性能会很差（扫描可达对象，需要大量内存，若一部分被置换出去，则需要再移入，因此会增加垃圾回收时间，导致JVM长期停滞）。</p>
  </li>
  <li>vmstat(free:可用空闲内存，si:页面移入数量,so:页面移出数量)</li>
  <li>锁竞争：
    <ul>
      <li>JDK1.5之前，通过CPU使用率和smtx（互斥量的自旋次数），可以监控应用中的锁竞争。</li>
      <li>JDK1.5以后，HotSpot VM通过线程循环自旋尝试获得锁，若若干次忙循环后仍然没有成功，则挂起该线程，等待被唤醒再尝试获得该锁。挂起和唤醒会导致操作系统让步式切换（代价为80 000个时钟周期）。该指标可以用来衡量锁竞争。</li>
      <li>mpstat(csw:上下文切换总和，icsw:抢占式上下文切换)</li>
      <li>一般原则：让步式上下文切换（csw-icsw）超过5%，表明出现锁竞争。</li>
      <li>命令行：sysstat包中pidstat -w (csw/s:让步式上下文切换) ： 报告的是每秒所有虚拟处理器让步式上下文切换数</li>
      <li>让步式上下文切换浪费时钟周期 = (pidstat -w 让步式上下文切换数)/(虚拟处理器个数)</li>
      <li>sample : pidstat -w -I -p 9391 5 每5秒监控进程号9391应用。</li>
      <li>计算方式： 处理器为3.0GHz双核，每秒3500上下文切换，每个虚拟处理器上下文切换 3500/2 = 1750,耗费时钟周期 1750 * 80 000 = 140 000 000,3GHz每秒时钟周期3000 000 000,则浪费的时钟周期 4.7% = 140 000 000/ 3000 000 000（超过3%,面临竞争）</li>
      <li>
        <p>工具推荐： Oracle Solaris Studio Performance Analyzer 最适合分析隔离和报告锁竞争</p>
      </li>
      <li>抢占式上下文切换：
        <ol>
          <li>让步式上下文切换线程主动释放CPU，抢占式上下文切换则因分配的时间片用尽被迫放弃CPU或者其他优先级更高的线程所抢占。mpstat(icsw)</li>
          <li>taskset 创建处理器组并将应用分配给处理器组。</li>
        </ol>
      </li>
      <li>线程迁移：
        <ol>
          <li>大多数操作系统CPU调度会将待运行的线程分配给上次运行的处理器，若出现处理器繁忙，调度程序会其迁移到其他的处理器运行。新的处理器没有缓存线程需要的数据以及状态，会带来性能问题。mpstat(migr)</li>
        </ol>
      </li>
    </ul>
  </li>
</ul>

<h2 id="网络io使用率">网络IO使用率</h2>
<ul>
  <li>分布式的Java应用的扩张和扩张收到网络带宽或者网络IO限制。当超过网络接口硬件的处理能力，将被放入系统缓冲区，导致应用延迟。
命令行：netstat；sysstat可选包，但是不提供网络使用率；nicstat(solaris移植)
    <pre><code class="language-Shell">  nicstat [-hnsz] [-i interface[,...]] | [interval [count]]
      -h 帮助信息
      -n 非本地接口
      -s 概要信息
      -z 跳过0值
      -i interface 网络接口名称
      interval 报告输出的频率（秒）
      count(采样数)
      (Int:网络接口设备名；rkb/s:每秒读入的KB数；wb/s:每秒写入的KB数；rPk/s:每秒读取KB数；
          wPk/s:每秒写入的包数；rAvs:每次读取的字节数；wAvs:每次写入的的平均字节数；
          %Util:接口使用率；Sat:饱和度)
</code></pre>
  </li>
  <li>
    <p>可以提供每秒发送/接收包数量（错误+ 冲突），少量冲突在以太网是正常的；大量的冲突由于网络接口卡出错、糟糕的线路或者自动协商机制。</p>
  </li>
  <li>每次读写数据量小而网络读写量大的应用会导致消耗大量的系统态CPU,产生大量系统调用。策略：减少网络读写的系统调用；使用非阻塞IO；减少处理请求和响应的线程数。误用原生的JDK NIO导致性能变差，建议使用NIO框架。
    <h2 id="磁盘使用率">磁盘使用率</h2>
  </li>
  <li>对于磁盘应用，查找性能问题，需要监控磁盘IO。
命令行：<code class="highlighter-rouge">iostat</code>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      sample : 
          iostat <span class="nt">-xc</span> 5<span class="o">(</span>磁盘使用率和CPU使用率<span class="o">)</span>
          iostat <span class="nt">-xm</span> 5<span class="o">(</span>磁盘使用率和系统态CPU使用率<span class="o">)</span>
</code></pre></div>    </div>
  </li>
  <li>为了判读读写哪个文件，使用Solaris 10和Solaris 11 Express在/usr/demo/dtrace目录下有一些DTrace脚步有助于监控磁盘活动，iosnoop.d提供详细信息（哪个用户，哪个进程，读写字节数，读写的问题件名称）
    <ul>
      <li>uid 执行磁盘操作用户ID</li>
      <li>pid 进程ID</li>
      <li>D R（读）或者W（写）</li>
      <li>BLOCK 磁盘块</li>
      <li>SIZE 数据读写字节数</li>
      <li>COMM 执行磁盘访问的名称</li>
      <li>PATHNAME 访问的文件名称</li>
      <li>优化策略：
        <ul>
          <li>更快的存储设备</li>
          <li>文件扩张到多个磁盘</li>
          <li>
            <p>操作系统调优可以缓存大量的文件系统数据结构</p>
          </li>
          <li>从应用的角度，减少磁盘的活动：使用带缓冲的输入输出流；减少读写次数；集中缓冲数据结构减少磁盘交互。缓冲区减少调用操作系统的调用次数从而降低CPU使用率</li>
          <li>关于磁盘性能，检查磁盘缓冲是否开启。开启会改善严重依赖磁盘IO的应用性能，但是意外的电源故障会导致数据损坏</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>



                <hr>


                <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC A-S 4.0 International License</a>.

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/blog/JVM-memory.html" data-toggle="tooltip" data-placement="top" title="JVM内存布局">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/blog/Performance-JVM.html" data-toggle="tooltip" data-placement="top" title="JVM架构">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- Duoshuo Share start -->
                <style>
                    .ds-share{
                        text-align: right;
                    }
                    
                    @media only screen and (max-width: 700px) {
                        .ds-share {

                        }
                    }
                </style>
                <!--
                <div class="ds-share"
                    data-thread-key="/blog/performance-os" data-title="性能调优-操作系统篇"
                    data-images="http://localhost:4000/img/fantasy.jpg"
                    data-content="性能监控
以一种非入侵的方式收集或者查看应用性能数据的活动。监控通常是一种在生产、质量评估或者开发环境中实施的带有预防性或者主动性的活动。

CPU使用率... | Microdust:Azeril's blog"
                    data-url="http://localhost:4000/blog/performance-os.html">
                    <div class="ds-share-inline">
                      <ul  class="ds-share-icons-16">

                        <li data-toggle="ds-share-icons-more"><a class="ds-more" href="#">分享到：</a></li>
                        <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>
                        <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
                        <li><a class="ds-douban" href="javascript:void(0);" data-service="douban">豆瓣</a></li>
                      </ul>
                      <div class="ds-share-icons-more">
                      </div>
                    </div>
                <hr>
                </div>
                -->
                <!-- Duoshuo Share end-->




                <!-- 多说评论框 start 
                <div class="comment">
                    <div class="ds-thread" data-thread-key="/blog/performance-os" data-title="性能调优-操作系统篇" data-url="http://localhost:4000/blog/performance-os.html"></div>
                </div>
                多说评论框 end -->
            </div>
        </div>
    </div>
</article>



<!-- 多说公共JS代码 start (一个网页只需插入一次) 
<script type="text/javascript">
var duoshuoQuery = {short_name:"azeril"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
多说公共JS代码 end -->



</script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>

  
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <!--
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/lqjacklee">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    -->

                    
                    <li>
                        <a href="https://github.com/lqjack">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <!--
                    
                    <li>
                        <a href="http://www.douban.com/people/lqjacklee">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-douban fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    

                    
                    <li>
                        <a href="https://www.facebook.com/lqjacklee">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    

                    
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/lqjacklee">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a target="_blank" href="http://weibo.com/lqjacklee">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    -->

                </ul>
                <p class="copyright text-muted">
                &copy; 2011~2019 lqjack ♪ Powered by Jack.
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>




<!-- Highlight.js -->
<script>
    async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js",function(){
        hljs.initHighlightingOnLoad();
    })
</script>
<link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">


</body>

</html>